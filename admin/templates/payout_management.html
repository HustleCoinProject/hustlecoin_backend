<!-- admin/templates/payout_management.html -->
{% extends "base.html" %}

{% block title %}Payout Management - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Payout Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-4">
                            <div class="statistic">
                                <div class="value">{{ stats.pending_count }}</div>
                                <div class="label">Pending</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="statistic">
                                <div class="value">{{ stats.completed_count }}</div>
                                <div class="label">Completed</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="statistic">
                                <div class="value">{{ stats.rejected_count }}</div>
                                <div class="label">Rejected</div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="mt-3">
                        <strong>Pending Total:</strong><br>
                        {{ stats.pending_total_kwanza }} AOA<br>
                        <small class="text-muted">{{ stats.pending_total_hc }} HC</small>
                    </div>
                    <div class="mt-2">
                        <strong>Completed Total:</strong><br>
                        {{ stats.total_completed_kwanza }} AOA<br>
                        <small class="text-muted">{{ stats.total_completed_hc }} HC</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Pending Payouts ({{ pending_payouts|length }})</h5>
                    <div>
                        <div class="btn-group me-2" role="group">
                            <a href="/admin/payouts/export-csv" class="btn btn-success btn-sm" 
                               {% if not pending_payouts %}disabled{% endif %}>
                                <i class="fas fa-download me-1"></i>Export CSV
                            </a>
                            <button type="button" class="btn btn-warning btn-sm" 
                                    onclick="showImportModal()" 
                                    {% if not pending_payouts %}disabled{% endif %}>
                                <i class="fas fa-upload me-1"></i>Import CSV
                            </button>
                        </div>
                        <div class="btn-group" role="group">
                            <a href="/admin/collection/payout" class="btn btn-secondary btn-sm">View All Payouts</a>
                            <button class="btn btn-primary btn-sm" onclick="location.reload()">Refresh</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if success %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        {{ success }}
                        {% if bulk_results %}
                        <div class="mt-2">
                            <small>
                                <strong>Details:</strong>
                                {% if bulk_results.success_details %}
                                <ul class="mb-0 mt-1">
                                    {% for detail in bulk_results.success_details %}
                                    <li>Payout {{ detail.payout_id }}: {{ detail.action }}d</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                                {% if bulk_results.errors %}
                                <strong class="text-danger">Errors:</strong>
                                <ul class="mb-0 mt-1">
                                    {% for error in bulk_results.errors %}
                                    <li class="text-danger">{{ error.payout_id }}: {{ error.error }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </small>
                        </div>
                        {% endif %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}
                    
                    {% if error %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        {% if validation_errors %}
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>CSV Validation Failed</h6>
                        <p>Please fix the following errors and re-upload your CSV file:</p>
                        <ul class="mb-0">
                            {% for error_msg in validation_errors %}
                            <li>{{ error_msg }}</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        {{ error }}
                        {% endif %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}
                    
                    {% if pending_payouts %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Details</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payout in pending_payouts %}
                                <tr>
                                    <td>
                                        <small class="text-muted">{{ payout.user_id }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ payout.amount_kwanza }} AOA</strong><br>
                                        <small class="text-muted">{{ payout.amount_hc }} HC</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info text-dark">
                                            {% if payout.payout_method == "multicaixa_express" %}
                                                Multicaixa
                                            {% else %}
                                                Crypto Transfer
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if payout.payout_method == "multicaixa_express" %}
                                            <strong>Phone:</strong> {{ payout.phone_number }}<br>
                                            <strong>Name:</strong> {{ payout.full_name }}<br>
                                            <strong>ID:</strong> {{ payout.national_id }}
                                        {% else %}
                                            <strong>Wallet:</strong> {{ payout.crypto_wallet_address }}<br>
                                            <strong>Network:</strong> {{ payout.crypto_network }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ payout.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-success btn-sm" 
                                                    onclick="processPayoutModal('{{ payout.id }}', 'approve')">
                                                Approve
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm" 
                                                    onclick="processPayoutModal('{{ payout.id }}', 'reject')">
                                                Reject
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No pending payouts at the moment.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Process Payout Modal -->
<div class="modal fade" id="processPayoutModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="processPayoutForm" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="processPayoutModalTitle">Process Payout</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="action" id="payoutAction">
                    
                    <div class="form-group">
                        <label for="adminNotes">Admin Notes (Optional):</label>
                        <textarea class="form-control" name="admin_notes" id="adminNotes" rows="3" 
                                  placeholder="Optional notes about this payout..."></textarea>
                    </div>
                    
                    <div class="form-group" id="rejectionReasonGroup" style="display: none;">
                        <label for="rejectionReason">Rejection Reason:</label>
                        <textarea class="form-control" name="rejection_reason" id="rejectionReason" rows="2" 
                                  placeholder="Please provide a reason for rejection..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn" id="processPayoutBtn">Process</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- CSV Import Modal -->
<div class="modal fade" id="csvImportModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form id="csvImportForm" method="post" action="/admin/payouts/import-csv" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">Import CSV for Bulk Processing</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Instructions:</h6>
                        <ol class="mb-0">
                            <li>First, click "Export CSV" to download the current pending payouts</li>
                            <li>Open the CSV file and fill in the <strong>"action"</strong> column with either "approve" or "reject"</li>
                            <li>For rejections, fill in the <strong>"rejection_reason"</strong> column</li>
                            <li>Optionally, add <strong>"admin_notes"</strong> for any payout</li>
                            <li>Save the file and select it below</li>
                        </ol>
                    </div>
                    
                    <div class="form-group">
                        <label for="csvFileInput">Select CSV File:</label>
                        <input type="file" class="form-control-file" name="csv_file" id="csvFileInput" 
                               accept=".csv" required>
                        <small class="form-text text-muted">
                            Select the CSV file with your approve/reject decisions. The file will be validated before processing.
                        </small>
                    </div>
                    
                    <div class="form-group" id="filePreviewGroup" style="display: none;">
                        <label>File Preview:</label>
                        <div id="csvPreview" class="border p-2 bg-light" style="height: 150px; overflow-y: auto;">
                            <small class="text-muted">Select a CSV file to see preview...</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Validation Rules:</h6>
                        <ul class="mb-0 small">
                            <li><strong>Action column:</strong> Must be exactly "approve" or "reject" (case-insensitive)</li>
                            <li><strong>Rejection reason:</strong> Required when action is "reject"</li>
                            <li><strong>Payout IDs:</strong> Must exist and be in pending status</li>
                            <li><strong>All-or-nothing:</strong> If ANY row has errors, the entire import will be rejected</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="importCSVBtn">
                        <i class="fas fa-upload me-1"></i>Process Payouts
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function processPayoutModal(payoutId, action) {
    const modal = document.getElementById('processPayoutModal');
    const form = document.getElementById('processPayoutForm');
    const title = document.getElementById('processPayoutModalTitle');
    const actionInput = document.getElementById('payoutAction');
    const button = document.getElementById('processPayoutBtn');
    const rejectionGroup = document.getElementById('rejectionReasonGroup');
    const adminNotesTextarea = document.getElementById('adminNotes');
    const rejectionReasonTextarea = document.getElementById('rejectionReason');
    
    // Set form action URL
    form.action = `/admin/payouts/${payoutId}/process`;
    
    // Set action
    actionInput.value = action;
    
    // Clear previous form data
    adminNotesTextarea.value = '';
    rejectionReasonTextarea.value = '';
    
    // Update UI based on action
    if (action === 'approve') {
        title.textContent = 'Approve Payout';
        button.textContent = 'Approve';
        button.className = 'btn btn-success';
        rejectionGroup.style.display = 'none';
        // Make rejection reason not required
        rejectionReasonTextarea.removeAttribute('required');
    } else {
        title.textContent = 'Reject Payout';
        button.textContent = 'Reject';
        button.className = 'btn btn-danger';
        rejectionGroup.style.display = 'block';
        // Make rejection reason required for rejection
        rejectionReasonTextarea.setAttribute('required', 'required');
    }
    
    // Show modal using Bootstrap 5 syntax
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Handle form submission with loading state
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('processPayoutForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('processPayoutBtn');
            const action = document.getElementById('payoutAction').value;
            const rejectionReason = document.getElementById('rejectionReason').value;
            
            // Validate rejection reason if action is reject
            if (action === 'reject' && !rejectionReason.trim()) {
                e.preventDefault();
                alert('Please provide a rejection reason.');
                return false;
            }
            
            if (submitBtn) {
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                
                // Re-enable button after 10 seconds in case of error
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }, 10000);
            }
        });
    }
});

// Auto-refresh removed - background processing doesn't need polling

// CSV Import functionality
function showImportModal() {
    const modal = document.getElementById('csvImportModal');
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// CSV file handling and preview
document.addEventListener('DOMContentLoaded', function() {
    const csvFileInput = document.getElementById('csvFileInput');
    const csvPreview = document.getElementById('csvPreview');
    const filePreviewGroup = document.getElementById('filePreviewGroup');
    
    if (csvFileInput) {
        csvFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            
            if (!file) {
                filePreviewGroup.style.display = 'none';
                return;
            }
            
            // Validate file type
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file (.csv extension required).');
                this.value = '';
                filePreviewGroup.style.display = 'none';
                return;
            }
            
            // Validate file size (max 1MB)
            if (file.size > 1024 * 1024) {
                alert('File is too large. Please select a CSV file smaller than 1MB.');
                this.value = '';
                filePreviewGroup.style.display = 'none';
                return;
            }
            
            // Read and preview file
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                
                try {
                    const lines = content.split('\n').filter(line => line.trim());
                    let preview = `<small><strong>File:</strong> ${file.name} (${(file.size / 1024).toFixed(1)} KB, ${lines.length} lines)</small><br>`;
                    
                    if (lines.length > 0) {
                        // Show header and first few data rows
                        const previewLines = lines.slice(0, 6); // Header + 5 data rows
                        preview += '<pre style="font-size: 0.8em; margin: 0; white-space: pre-wrap;">';
                        
                        previewLines.forEach((line, index) => {
                            const displayLine = line.length > 100 ? line.substring(0, 100) + '...' : line;
                            const lineType = index === 0 ? 'Header' : `Row ${index}`;
                            preview += `${lineType}: ${displayLine}\n`;
                        });
                        
                        if (lines.length > 6) {
                            preview += `... and ${lines.length - 6} more data rows\n`;
                        }
                        
                        preview += '</pre>';
                        
                        // Check for required columns in header
                        if (lines[0]) {
                            const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
                            const requiredColumns = ['payout_id', 'action'];
                            const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                            
                            if (missingColumns.length > 0) {
                                preview += `<div class="alert alert-danger mt-2 p-2"><small><strong>⚠️ Missing required columns:</strong> ${missingColumns.join(', ')}</small></div>`;
                            } else {
                                preview += `<div class="alert alert-success mt-2 p-2"><small><strong>✅ Required columns found</strong></small></div>`;
                            }
                        }
                    }
                    
                    csvPreview.innerHTML = preview;
                    filePreviewGroup.style.display = 'block';
                    
                } catch (error) {
                    csvPreview.innerHTML = '<small class="text-danger">Error reading file: ' + error.message + '</small>';
                    filePreviewGroup.style.display = 'block';
                }
            };
            
            reader.onerror = function() {
                csvPreview.innerHTML = '<small class="text-danger">Error reading file</small>';
                filePreviewGroup.style.display = 'block';
            };
            
            reader.readAsText(file);
        });
    }
    
    // Handle CSV import form submission
    const csvImportForm = document.getElementById('csvImportForm');
    if (csvImportForm) {
        csvImportForm.addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('importCSVBtn');
            const fileInput = document.getElementById('csvFileInput');
            
            if (!fileInput.files[0]) {
                e.preventDefault();
                alert('Please select a CSV file before submitting.');
                return false;
            }
            
            // Show confirmation dialog
            const file = fileInput.files[0];
            if (!confirm(`Are you sure you want to process the CSV file "${file.name}"?\n\nThis will validate and process all payouts in the file. The operation cannot be undone.`)) {
                e.preventDefault();
                return false;
            }
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Validating & Processing...';
                
                // Re-enable button after 60 seconds in case of error
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-upload me-1"></i>Process Payouts';
                }, 60000);
            }
        });
    }
});
</script>

<style>
.statistic {
    text-align: center;
    padding: 10px;
}

.statistic .value {
    font-size: 1.5em;
    font-weight: bold;
    color: #007bff;
}

.statistic .label {
    font-size: 0.9em;
    color: #6c757d;
}

.bg-info {
    background-color: #0dcaf0 !important;
}
</style>
{% endblock %}
